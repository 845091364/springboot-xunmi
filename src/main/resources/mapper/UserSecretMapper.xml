<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.springboot.mapper.UserSecretMapper">
	<resultMap id="BaseResultMap" type="com.springboot.model.UserSecret">
		<id column="id" property="id" />
		<result column="content" property="content" />
		<result column="user_id" property="userId" />
		<result column="create_time" property="createTime" />
	</resultMap>
	<resultMap id="openSecret" type="com.springboot.model.OpenSecret">
		<id column="id" property="id" />
		<result column="secret_id" property="secretId" />
		<result column="user_id" property="userId" />
		<result column="create_time" property="createTime" />
	</resultMap>
	<resultMap id="questions" type="com.springboot.model.Questions">
		<id column="id" property="id" />
		<result column="title" property="title" />
	</resultMap>
	<resultMap id="questionsAnswer" type="com.springboot.model.QuestionsAnswer">
		<id column="id" property="id" />
		<result column="questions_id" property="questionsId" />
		<result column="answer" property="answer" />
		<result column="status" property="status" />
	</resultMap>
	<select id="getAnswer" resultMap="questionsAnswer"		parameterType="java.lang.Integer">
		select * from questions_answer where questions_id=#{id}
	</select>
	<select id="getQuestions" resultMap="questions">
		select * from questions
		order by rand() limit 3
	</select>
	<insert id="insert" parameterType="com.springboot.model.UserSecret">
		insert into
		user_secret(content,user_id,create_time)
		values(#{content},#{userId},now())
	</insert>
	<select id="getUserSecret" resultMap="BaseResultMap" parameterType="java.util.List">
		select * from user_secret where 1=1 
		<if test="list!=null and  list.size()>0">
		and id  not in 
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">  
        #{item.secretId}  
    	</foreach> 
		</if>
		order by rand() limit 1
	</select>

	<insert id="insertOpenSecret" parameterType="com.springboot.model.OpenSecret">
		insert into
		open_secret(secret_id,user_id,create_time)
		values(#{secretId},#{userId},now())
	</insert>

	<select id="getOpenSecret" parameterType="com.springboot.model.OpenSecret"
		resultMap="openSecret">
		select * from open_secret where 1=1
		<if test="secretId!=null">
			and secret_id=#{secretId}
		</if>
		<if test="userId!=null">
			and user_id=#{userId}
		</if>
	</select>

	<select id="getTop" resultType="hashMap" parameterType="java.lang.Integer">
		select u.id as id,u.name as name,u.description as description,u.birthday as birthday,
		u.sex as sex,u.photo as photo,count(os.user_id) as countNum from open_secret os join user u on
		u.id=os.user_id
		where 
		<if test="type==1">
			to_days(os.create_time) = to_days(now())
		</if>
		<if test="type==2">
		  	YEARWEEK(date_format(os.create_time,'%Y-%m-%d')- INTERVAL 1 DAY) = YEARWEEK(now())
		</if>
		<if test="type==3">
			date_format(os.create_time,'%Y-%m')=date_format(now(),'%Y-%m')
		</if>
		GROUP BY os.user_id
		order by COUNT(os.user_id) desc limit 10
	</select>

	<select id="getOpenSecretAll"  resultType="hashMap" parameterType="java.lang.Integer">
	select u.photo as photo,u.sex as sex,u.name as name,u.birthday as birthday,
	u.description as description,us.content as content,us.id  as secretId
	from open_secret  os  join user_secret  us  on  us.id=os.secret_id  join user  u  on  u.id=us.user_id
	where os.user_id=#{userId}
	order  by os.create_time desc
	</select>
	<select id="getPublish" resultMap="BaseResultMap" parameterType="java.lang.Integer">
	select * from user_secret  where user_id=#{userId}
	order by create_time desc
	</select>
	
	<select id="getBySecretId" resultMap="BaseResultMap" parameterType="java.lang.Integer">
		select * from user_secret  where id=#{secretId}
	</select>
	<select id="deleteBySecretId"  parameterType="java.lang.Integer">
		delete  from user_secret where id=#{secretId}
	</select>
	<select id="deleteByOpenSecret"  parameterType="java.lang.Integer">
		delete  from open_secret where secret_id=#{secretId}
	</select>
</mapper>